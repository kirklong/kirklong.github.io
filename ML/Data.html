<!DOCTYPE html>
<html>
<head>
    <!-- pretty table loading -->
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=yes" name="viewport">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS"
    crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
    <!-- end pretty table requirements -->

    <title>Machine Learning Project</title>
    <link rel="stylesheet" type="text/css" href="css/styles.css">
    <link href="css/prism.css" rel="stylesheet" />
</head>
<body>
    <script src="js/prism.js"></script>
    <div class="banner">
        <h1>Machine Learning Project</h1>
        <div class="tabs">
            <a href="HomePageIntro.html">Introduction</a> 
            <a class = "active",href="Data.html">DataPrep/EDA</a>
            <a href="Clustering.html">Clustering</a>
            <a href="ARM.html">ARM</a>
            <a href="DT.html">DT</a>
            <a href="NB.html">NB</a>
            <a href="SVM.html">SVM</a>
            <a href="Regression.html">Regression</a>
            <a href="NN.html">NN</a>
            <a href="Conclusions.html">Conclusions</a>
        </div>
    </div>
    <div class="content">
        <h2>DataPrep/EDA</h2>
        <h3>Observational data</h3>
        <p>
            There are a variety of public astrophysics datasets available, but perhaps the best / most consistent for large amounts of observational data comes from the <a href="https://www.sdss.org/">Sloan Digital Sky Survey (SDSS)</a>. 
            SDSS first began taking data in 2000, and has since released 18 data releases (DR) of data. It has imaged over 1/3 of the sky and contains photometric observations of around 1 billion objects, with more detailed spectral observations of more than 4 million objects.
            The size, consistency, and quality of the data makes it an ideal dataset for machine learning applications. To address the questions posed in the <a href="HomePageIntro.html">Introduction</a>, we will obtain quasar, galaxy, and star data from SDSS, using the most recent data release (DR18).
        </p>
        <p>Fortunately, SDSS makes all of their data publicly accessible through a variety of APIs. The SDSS database can be accessed through <a href="https://skyserver.sdss.org/">SkyServer</a>. 
            We can query the database programmatically using SQL syntax from the <a href="https://skyserver.sdss.org/dr18/SkyServerWS/SearchTools/SqlSearch?">https://skyserver.sdss.org/dr18/SkyServerWS/SearchTools/SqlSearch?</a> endpoint.
            SDSS data releases are cumulative, so we can query the database for all objects SDSS has ever observed by accessing the "dr18" folder. From there we must tell the server that we are looking to use the SQLSearch tool on SkyServer, information which is contained in the latter half of the URL.
            To successfully query the database, we must provide a valid SQL query with the "cmd" parameter. For example, to obtain the locations on the sky of the first 10 stars in the database we would construct the following SQL query:
            <pre><code class="language-SQL">
SELECT TOP 10
p.ra,p.dec
FROM PhotoObj AS p
    JOIN SpecObj AS s ON s.bestobjid = p.objid
WHERE
    s.class = 'STAR'
            </code></pre>
            This query selects the right ascension (ra) and declination (dec) for the first 10 stars in the database, as these parameters are astronomical coordinates that point to the location of an object on the sky. 
            The "PhotoObj" table contains all the photometric information for each object (including where the telescope was pointing) but to distinguish between objects we often need spectra, whose information we can obtain from the "SpecObj" table.
            The "SpecObj" table thus contains the critical information on whether the imaged object is likely a star or not, which is why we join the two tables on the "bestobjid" and "objid" columns.
            </p>
            <p>
            But we're not done yet. To actually get the data, we must send a GET request to the URL with the SQL query as a parameter, and to do this we have to reformat things a little bit. To format this correctly for our request, 
            we have to replace many of the characters in the query with their URL encoded equivalents. For example, spaces become "%20", and the equals sign becomes "%3D". 
            We also need to tell the server what kind of format we would like our output in by appending the "&format=" parameter, and if we want to give the resulting table a name via the "&name=" parameter. It's best not to hard-code the number of objects to return either, but we can set up our function to allow this as a free parameter we can change.
            We can accomplish these tasks in Python with the help of regex (via the "re" module), executing the final GET 
            request using "wget" from the command line (which we access with the "os" module in Python). The following function takes a SQL query like the one above, reformats it and combines it with the SkyServer endpoint to form a functional URL, then executes the GET request in the terminal to actually obtain the data, returning the URL for debugging:
            <pre><code class="language-python">
import os, re
def getObjTable(SQL_query, format="csv", fname="queryResults", TableName="",N=100000):
    """Retrieve table of N SDSS objects using SQL query
    params: SQL_query [str] - SQL query to be executed
            format [str] - format of table, options are 'csv', 'html', 'xml', 'json'
            TableName [str] - name of table, default is empty string
            N [int] - number of objects to retrieve, default is 100000, limit is 500000
    returns: query [str] - url of reformatted query, downloaded with wget and saved as {fname}.{format}
    """
    SQL_query = SQL_query.format(N)
    base_url = "https://skyserver.sdss.org/dr18/SkyServerWS/SearchTools/SqlSearch?cmd="
    SQL_formatted = re.sub(r"\n", "%0D%0A", SQL_query)
    SQL_formatted = re.sub(r"\+", "%2B", SQL_formatted)
    SQL_formatted = re.sub(r"\s", "+", SQL_formatted)
    SQL_formatted = re.sub(r"=", "%3D", SQL_formatted)
    SQL_formatted = re.sub(r",", "%2C", SQL_formatted)
    SQL_formatted = re.sub(r"'", "%27", SQL_formatted)
    SQL_formatted = re.sub(r"\(", "%28", SQL_formatted)
    SQL_formatted = re.sub(r"\)", "%29", SQL_formatted)
    query = base_url + SQL_formatted + "%0D%0A%0D%0A&format={0}&TableName={1}".format(format, TableName)
    os.system("wget -O {0}.{1} '".format(fname,format) + query + "'")
    return query
            </code></pre>
            Using this code, the full URL for our SQL search above would thus become: <a href="https://skyserver.sdss.org/dr18/SkyServerWS/SearchTools/SqlSearch?cmd=SELECT+TOP+10%0D%0Ap.ra%2Cp.dec%0D%0AFROM+PhotoObj+AS+p%0D%0A+JOIN+SpecObj+AS+s+ON+s.bestobjid+%3D+p.objid%0D%0AWHERE%0D%0A+s.class+%3D+%27STAR%27%0D%0A%0D%0A&format=csv&TableName=">"https://skyserver.sdss.org/dr18/SkyServerWS/SearchTools/SqlSearch?cmd=SELECT+TOP+10%0D%0Ap.ra%2Cp.dec%0D%0AFROM+PhotoObj+AS+p%0D%0A+JOIN+SpecObj+AS+s+ON+s.bestobjid+%3D+p.objid%0D%0AWHERE%0D%0A+s.class+%3D+%27STAR%27%0D%0A%0D%0A&format=csv&TableName="</a>
        </p>
        <p>To accomplish the goals of this project we're going to need a lot more data than just the location of a few stars, however. In reality, we will need a lot of data on stars, galaxies, and quasars, and we will want to compare many parameters against each other. 
            A good starting point for parameters would probably be to return the position (ra and dec), redshift (a measure of how far away an object is), the spectral flux in each band, the apparent brightness in each imaging band, the estimated on-sky size in each imaging band,
            the time each observation was taken (to account for objects with multiple observations), as well as other identifying info we can use to query different APIs later. Thus, a full sample SQL command that is more useful would go something like:
            <pre><code class="language-SQL">
SELECT TOP 500000
s.specObjID, s.class, s.z as redshift, s.zErr as redshiftError, s.spectroSynFluxIvar_u, s.spectroSynFluxIvar_g, s.spectroSynFluxIvar_r, s.spectroSynFluxIvar_z, s.spectroSynFluxIvar_i, s.spectroSynFlux_i, s.spectroSynFlux_z, s.spectroSynFlux_u, s.spectroSynFlux_g, s.plate, s.mjd, s.fiberid, s.run2d, p.objid, p.ra, p.dec, p.u, p.g, p.r, p.i, p.z, p.fieldID, p.err_u, p.err_g, p.err_r, p.err_i, p.err_z, p.petroRad_u, p.petroRad_g, p.petroRad_r, p.petroRad_i, p.petroRad_z, p.petroRadErr_u, p.petroRadErr_g, p.petroRadErr_r, p.petroRadErr_z, p.petroRadErr_i
FROM PhotoObj AS p
    JOIN SpecObj AS s ON s.bestobjid = p.objid
WHERE 
    (s.class = 'GALAXY') AND (zWarning = 0)
            </code></pre>
            Using <code class="language-python">getObjTable</code> on this SQL command would thus return 500,000 galaxies with the above parameters. We can then repeat this process for stars and quasars by changing the "s.class" parameter to "STAR" and "QSO" respectively. In this way we have obtained a good starting point in terms of observational data for the project &mdash; a combined sample of more than a million objects with spectra (more than 1/4 of all of what is available in SDSS).
            In total these CSV files run about 200 MB each, so altogether this is a substantial amount of data. 
        </p>
        <p>Let's look at a sample of what some of this returned data looks like. Opening the CSV with all of the quasar data, the first few rows of (uncleaned) data look something like this:</p>

        <div class="container-fluid">
            <main class="row">
                <div class="col">
                    <div id="sampleQueryData"></div>
                </div>
            </main>
        </div>

        <p>When cleaning this data...LEFT OFF HERE</p>

        <h4>Visualizing SDSS data</h4>
        <p>Of course, a natural question would be to ask &mdash; what do these objects actually look like? Astronomers are blessed to study beautiful things, and fortunately SDSS makes it easy to query their API for more detailed images and spectral data for any of the objects in their database.
            SkyServer also hosts images for every object, which we can obtain from the <a href="http://skyserver.sdss.org/dr18/SkyServerWS/ImgCutout/getjpeg?">"http://skyserver.sdss.org/dr18/SkyServerWS/ImgCutout/getjpeg?"</a> endpoint by providing at least the ra and dec of the object as the "ra" and "dec" parameters.
            We will accomplish this task again in Python with a custom function that formats the url appropriately and sends a GET request via the system's wget:
        </p>
        <pre><code class="language-python">
def getImg(id,opt="GL",width=512,height=512,scale=0.4):
    """Retrieve images of SDSS objects
    params: id [dict] - dictionary of object identifiers, requires at least 'specObjID', 'ra', and 'dec'
            opt [str] - options for image cutout, documentation: https://skyserver.sdss.org/dr14/en/help/docs/api.aspx#imgcutout; defaults to 'GL' (grid + label)
            width [int] - width of image in pixels
            height [int] - height of image in pixels
            scale [float] - scale of image in arcsec/pixel

    returns: url [str] - url of image cutout, downloaded with wget and saved as images/image_{specObjID}.jpeg 
    """

    url = "http://skyserver.sdss.org/dr18/SkyServerWS/ImgCutout/getjpeg?ra={0}&dec={1}&width={2}&height={3}&scale={4}&opt={5}".format(id['ra'],id['dec'],width,height,scale,opt)
    os.system("wget -O images/image_{0}.jpeg '".format(str(int(id['specObjID']))) + url + "'")
    return url
        </code></pre>
        <div class="leftWrapFigure">
            <p><img src="img/image_299489677444933632.jpeg" alt="SDSS galaxy image" width="512" height="512">
                <figcaption>Sample SDSS galaxy image downloaded with <code class="language-python">getImg</code> and passing the options "GL" to obtain the grid and label.</figcaption>
            </p>
        </div>
        <p>
            To use this function we must also have a dictionary of object identifiers, which we can obtain from the CSV files we downloaded earlier. For example, to get the image of the first galaxy in the CSV file (assuming that earlier we saved it as "GAL_query.csv") we would do:
            <pre><code class="language-python">
def getID(row,fname):
    row += 2 # skip table name + column names
    with open(fname,"r") as f:
        lines = f.readlines()
        d = lines[row].split(",")
        colNames = lines[1].split(",")
    return dict(zip(colNames,d)) 

firstGalID = getID(0,"GAL_query.csv")
getImg(firstGalID) # returns url of image, downloads image to images/image_{specObjID}.jpeg
        </code></pre>
        </p>
        <p>
            We can see that it works, and obtains a nice image of a galaxy. All of the useful parameters we get from a visual image have already been downloaded from the database (i.e. the brightness and object size in different bands), but it's still fun to look at! But what about the spectra? SkyServer also hosts pre-reduced spectra for each object, which we can download from the <a href="https://skyserver.sdss.org/dr18/en/get/specById.ashx?">https://skyserver.sdss.org/dr18/en/get/specById.ashx?</a> endpoint by passing the object's specObjID as the "ID" parameter. 
            However, SkyServer only produces "quick-looks" of the spectra, which are useful for visual diagnostics but unfortunately does not contain the actual spectral data. 
            To obtain the actual data in a machine readable format we must query the Science Archive Server (SAS) endpoint at <a href="http://dr18.sdss.org/optical/spectrum/view/data/format={format}">http://dr18.sdss.org/optical/spectrum/view/data/format={format}</a>, where the format can be "csv" or "fits". "Fits" (short for flexible image transport system) are a common binary format for astronomical data, but they can be a little harder to work with than just a standard CSV file.
            We must also append the spectral identifiers to the url via the "spec", "plateid", "mjd", "fiberid", and "run2d" parameters. We'll again accomplish all of this via a custom Python function that will return the spectrum in the format we want based on an "id" dictionary (like we created above):
        </p>
        <div class="leftWrapFigure">
            <p><img src="img/spectrum_299489677444933632.png" alt="SDSS galaxy spectrum" width="512" height=auto>
                <figcaption>Sample SDSS galaxy spectrum quick-look downloaded with <code class="language-python">getSpectrum</code>.</figcaption>
            </p>
        </div>
        <pre><code class="language-python">
def getSpectrum(id,format='png',spec='lite'):
    """Retrieve spectra of SDSS objects
    params: id [dict] - dictionary of object identifiers, requires at least 'specObjID'
            format [str] - format of spectrum, options are 'png', 'fits', 'csv'
            spec [str] - either 'lite' (default) or 'full'
    returns: url [str] - url of spectrum, downloaded with wget and saved as spectra/spectrum_{specObjID}.{format}
    """

    if format == 'png':
        base_url = "https://skyserver.sdss.org/dr18/en/get/specById.ashx?ID="
        url = base_url + str(int(id['specObjID']))
    elif format == 'fits' or format == 'csv':
        url = "http://dr18.sdss.org/optical/spectrum/view/data/format={4}/spec={5}?plateid={0}&mjd={1}&fiberid={2}&reduction2d={3}".format(str(int(id['plate'])), str(int(id['mjd'])), str(int(id['fiberid'])), str(int(id['run2d'])),format,spec)
    os.system("wget -O spectra/spectrum_{0}.{1} '".format(str(int(id['specObjID'])),format) + url + "'")
    return url

getSpectrum(firstGalID) # returns url of spectrum, downloads spectrum to spectra/spectrum_{specObjID}.{format}, in this case downloading the quick-look png by default.
        </code></pre>

        <p>
            This is a great default visualization, but here there is data we will want to access that is not included in the data-base parameter download from earlier. 
            If we opt to download the spectrum as a CSV or FITS file we can access the individual flux values obtained by the instrument at every wavelength, which is useful because we may want to compare just portions of the spectra (i.e. where a strong common spectral line exists) from one object to another.
        </p>
        <div class="leftWrapFigure">
            <p><img src="img/sampleSpectrumData.png" alt="SDSS galaxy spectrum" width="512" height=auto>
                <figcaption>The same galaxy spectrum from before, this time visualized as a few of the actual data rows (in total there are 3818 rows of data) obtained with<code class="language-python">getSpectrum(firstGalID,format='csv')</code>.</figcaption>
            </p>
        </div>
        <p>Here we see the actual spectral data contains four columns: Wavelength, Flux, BestFit, and SkyFlux. Wavelength is the x-axis quantity of the plot shown above (in units of Angstroms), while the other three columns tell us how much light was seen at that wavelength with a few different classifications. 
            The "Flux" column contains simply the raw "flux" from the detector while the "BestFit" column contains the value from a best fit model to the entire spectrum. 
            The "SkyFlux" column contains how much light at that wavelength was detected from the background sky, not the actual object itself. All three of these columns have units of flux as shown on the y-axis of the spectrum plot. What goes into the model "BestFit" category is very complicated, and the culmination of several decades of instrumentation and astrophysical modelling, and for the rest of the project we will use this column whenever using spectral data, although we will compare and check how this choice may influence results by using the standard "Flux" column.
        </p>
        <h3>Distinguishing between stars, galaxies, and quasars with spectra</h3>
        <p>
            When first obtaining our data, we had to use the "class" identifier from the SpecObj table to distinguish between stars, galaxies, and quasars. But how does SDSS actually determine this? The answer is through spectra.
            While in our first example it was pretty clear from the photograph that the object in question was a galaxy, oftentimes galaxies are so far away that they appear as faint smudges of light on the sky, and they can be hard to tell apart from stars.
            Take the following three images, for example:
        </p>
        <div class="centerFigure3">
            <img src="img/STAR_dot.jpeg">
            <img src="img/GAL_dot.jpeg">
            <img src="img/QSO_dot.jpeg">
        </div>        
        <p>One is a galaxy, one is a star, and one is a quasar. But which is which? Looking at each object's spectra yields the clues we need to determine this:</p>
        <div class="centerFigure3">
            <img src="img/STAR_spectrumSample.png">
            <img src="img/GAL_spectrumSample.png">
            <img src="img/QSO_spectrumSample.png">
        </div>
        <p>The star is leftmost, the galaxy in the middle, and the quasar on the right. While they might be harder to identify with the images alone, the spectra look markedly different for each class of object. 
        The star has the characteristic signature of an object radiating at least somewhat like a blackbody (an object whose temperature determines its spectrum &mdash; we can measure the temperature by measuring where the spectrum peaks). The galaxy and the quasar, however, do not show this kind of emission.
        This indicates that the galaxy and quasar have other radiative processes at work. If we look at the y-axis scale of each spectrum we see that the star has a much larger range than either the quasar or galaxy &mdash; comparatively speaking their spectra are relatively flat, with large spikes around prominent emission lines only.
        How then do we determine the difference between the galaxy and the quasar? One way to distinguish the two is to compare their emission lines. When looking at the galaxy spectrum we see that the emission lines are narrow spikes above the continuum, but in the quasar spectrum these are much broader features.
        These broader features are called "broad emission lines" and are a hallmark of quasars. The broadening of these emission lines is a marker that the gas that produced this emission was moving at high speeds, and we believe that these high speeds are caused by the emitting gas orbiting around a supermassive black hole.
        Normal galaxies also have supermassive black holes, but we believe they aren't actively eating, and thus they have no hot emitting gas close enough to their black holes to show this characteristic broadening that is associated with quasars. Another distinguishing factor is in the redshift &mdash; quasars usually have much higher 
        redshifts than typical galaxies, indicating they are much farther away, which means that if they appear roughly as bright as a galaxy much closer to us they must be intrinsically <em>much</em> more luminous than the galaxy. This is another predicted feature 
        of accretion onto a supermassive black hole, and is one of the many reasons why quasars are so interesting to study, and so important to identify in our surveys.
        </p>



    <!-- PRETTY TABLE JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.2.1/js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery.csv.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
    <script src="js/csv_to_html_table.js"></script>

    <script>
        var CSVList = ['data/QSO_querySample.csv'];
        var idList = ['sampleQueryData'];
        // function format_link(link) {
        //     if (link)
        //         return "<a href='" + link + "' target='_blank'>" + link + "</a>";
        //     else return "";
        // }
        for (var i = CSVList.length - 1; i >= 0; i--){
            CSVList[i];
            idList[i];
            CsvToHtmlTable.init({
                csv_path: CSVList[i],
                element: idList[i],
                allow_download: true,
                csv_options: {
                    separator: ",",
                    delimiter: '"'
                },
                datatables_options: {
                    paging: false,
                    responsive: true,
                    scrollCollapse: true,
                    autowidth: true,
                    info: true,
                    scrollX: true,
                    scrollY: true,
                    searching: true
                },
                // custom_formatting: [
                //     [4, format_link]
                // ]
            });
        }
    </script>
    <!-- END PRETTY TABLE JS -->
</body>

</html>